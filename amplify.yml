version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        - npm run build
        # Debug: list a few folders so logs show what was created
        - echo "==== build output listing root ===="
        - ls -la || true
        - echo "==== .next listing ===="
        - ls -la .next || true
        - echo "==== .next/output listing ===="
        - ls -la .next/output || true
        - |
          # If Next wrote to out/ already, keep it. Otherwise if Next produced .next/output/static
          # copy that into out/ so Amplify can publish it.
          if [ -d "out" ]; then
            echo "Found out/ - using it as artifacts."
          elif [ -d ".next/output/static" ]; then
            echo "Found .next/output/static - copying into out/"
            rm -rf out || true
            mkdir -p out
            cp -r .next/output/static/* out/
          elif [ -d ".next/server/pages" ]; then
            # fallback: if pages were pre-rendered into .next/server/pages, copy those html files
            echo "Found .next/server/pages - copying static html into out/ (best-effort)"
            rm -rf out || true
            mkdir -p out
            # copy html files
            find .next/server/pages -name '*.html' -exec cp --parents {} out/ \; || true
            # also copy any static assets:
            if [ -d ".next/static" ]; then
              cp -r .next/static/* out/_next/static/ || true
            fi
          else
            echo "No recognized static output directory found. Build might be SSR-only or failed to export."
            echo "You can inspect the build logs above for details."
          fi
  artifacts:
    baseDirectory: out
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
